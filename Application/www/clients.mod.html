<div class="w3-container w3-padding-24">
    <div class="w3-card-4 w3-padding-16 w3-dark-grey">

        <h1 class="w3-center" disabled="">Clients in Rooms</h1>
        <div class="w3-container w3-padding-16" id="client_list_associated">
        </div>

        <h1 class="w3-center" disabled="">Clients Free</h1>
        <div class="w3-container w3-padding-16" id="client_list_free">
        </div>

        <button class="w3-button w3-round w3-black w3-margin" id="test">Add new Client</button>
    </div>
</div>

<div class="w3-modal" id="modal">

    <div class="w3-modal-content">
        <div class="w3-container">

            <div class="w3-card-4 w3-dark-grey">
    
                <div class="w3-container w3-center">
                    <h1><b id="clientName"></b> options</h1>
                </div>

                <button class="w3-button w3-round w3-black w3-margin w3-padding" onclick="deleteChannelFromGroup()">Delete from Group</button>
                <button class="w3-button w3-round w3-black w3-margin w3-padding" onclick="closeModal('modal')">Close</button>

            </div>

        </div>
    </div>

</div>

<div class="w3-modal" id="modalfree">

    <div class="w3-modal-content">
        <div class="w3-container">

            <div class="w3-card-4 w3-padding-16 w3-dark-grey">
    
                <div class="w3-container w3-center">
                    <h1><b id="clientNamefree"></b> options</h1>
                </div>

                <button class="w3-button w3-round w3-black w3-margin w3-padding" onclick="loadModal1()">Add to Group</button>
                <button class="w3-button w3-round w3-black w3-margin w3-padding" onclick="closeModal('modalfree')">Close</button>
                
            </div>

        </div>
    </div>

</div>
    
<div class="w3-modal" id="modal1">

    <div class="w3-modal-content">
        <div class="w3-container">

            <div class="w3-card-4 w3-padding-16 w3-dark-grey">
    
                <div class="w3-container w3-center">
                    <h1>Add channel to room</h1>
                </div>

                <label class="w3-margin w3-padding"><b>Room</b></label>
                <input class="w3-input w3-border w3-round w3-margin-top w3-margin-bottom" type="text" id="groupSend" required autofocus>

                <button class="w3-button w3-round w3-black w3-margin w3-padding" onclick="addChannelToGroup()">Add</button>
                <button class="w3-button w3-round w3-black w3-margin w3-padding" onclick="closeModal('modal1')">Close</button>
                
            </div>

        </div>
    </div>

</div>

<script type="text/javascript">

    function deleteChannelFromGroup(){

        var url = "https://broker.dalher.net/v3/channels/link/"+ sessionStorage.clientName;

        $.ajax({

            url: url,
            type: 'delete',
            headers: {
                "Authorization" : "Bearer " + sessionStorage.access_token
            },
            beforeSend: function(){
                console.log("Borrando suscripci贸n de un Cliente...");
            },
            success: function(response){
                console.log("Suscripci贸n Borrada");

                var old = document.getElementById('client_list_associated').getElementsByTagName('button');
                var i;
                for(i = 0 ; i < old.length ; i++){
                    if(old[i].id == sessionStorage.clientName){
                        old[i].remove();
                    }
                }

                var button = document.createElement("button");
                var node = document.createTextNode(sessionStorage.clientName);
                button.className = "w3-button w3-block w3-border";
                button.setAttribute('onclick', "loadModalFree('"+ sessionStorage.clientName +"')");
                button.appendChild(node);

                var newBtn = document.getElementById("client_list_free");
                newBtn.appendChild(button);

                closeModal('modal');
            },
            error: function(response){
                console.log("Error");
                console.log(response);
            },
            complete: function(jqXHR){
                console.log(jqXHR.status);
            }

        });

    }

    function addChannelToGroup(){

        var groupName = document.getElementById("groupSend").value;
        var url = "https://broker.dalher.net/v3/channels/link/"+ sessionStorage.clientName +"/"+ groupName;

        $.ajax({

            url: url,
            type: 'post',
            headers: {
                "Authorization" : "Bearer " + sessionStorage.access_token
            },
            beforeSend: function(){
                console.log("Creando suscripci贸n de un Cliente...");
            },
            success: function(response){
                console.log("Suscripci贸n Creada");

                var old = document.getElementById('client_list_free').getElementsByTagName('button');
                var i;
                for(i = 0 ; i < old.length ; i++){
                    if(old[i].id == sessionStorage.clientName){
                        old[i].remove();
                    }
                }

                var button = document.createElement("button");
                var node = document.createTextNode(sessionStorage.clientName);
                button.className = "w3-button w3-block w3-border";
                button.setAttribute('id', sessionStorage.clientName);
                button.setAttribute('onclick', "loadModal('"+ sessionStorage.clientName +"')");

                button.appendChild(node);

                var newBtn = document.getElementById("client_list_associated");
                newBtn.appendChild(button);

                closeModal('modal1');
                closeModal('modalfree');
            },
            error: function(response){
                console.log("Error");
                console.log(response);
            },
            complete: function(jqXHR){
                console.log(jqXHR.status);
            }

        });

    }

    function loadModal(channel){

        $('#clientName').empty();
        $('#clientName').append(channel);

        sessionStorage.setItem('clientName', channel);

        document.getElementById('modal').style.display = 'block';

    }

    function loadModal1(){

        document.getElementById('modal1').style.display = 'block';

    }

    function loadModalFree(channel){

        $('#clientNamefree').empty();
        $('#clientNamefree').append(channel);

        sessionStorage.setItem('clientName', channel);

        document.getElementById('modalfree').style.display = 'block';

    }

    function closeModal(id){

        document.getElementById(id).style.display = 'none';

    }

    function getClientListAssociated(freeClients){

        $.ajax({

            url: 'https://broker.dalher.net/v3/channels/list',
            type: 'get',
            headers: {
                "Authorization" : "Bearer " + sessionStorage.access_token
            },
            beforeSend: function(){
                console.log("Obteniendo Clientes del Usuario...");
            },
            success: function(response){
                console.log("Obtenidos...");
                console.log(response);

                var i;
                for(i = 0 ; i < response.length ; i++){
                    if(freeClients.indexOf(response[i].channel) == -1){
                        var button = document.createElement("button");
                        var node = document.createTextNode(response[i].channel);
                        button.className = "w3-button w3-block w3-border";
                        button.setAttribute('id', response[i].channel);
                        button.setAttribute('onclick', "loadModal('"+ response[i].channel +"')");

                        button.appendChild(node);

                        var newBtn = document.getElementById("client_list_associated");
                        newBtn.appendChild(button);
                    }
                }

            },
            error: function(){
                console.log("Error");
                console.log(response);
            }

        });

    }

    function getClientListFree(){

        $.ajax({

            url: 'https://broker.dalher.net/v3/channels/list/free',
            type: 'get',
            headers: {
                "Authorization" : "Bearer " + sessionStorage.access_token
            },
            beforeSend: function(){
                console.log("Obteniendo Clientes Libres del Usuario...");
            },
            success: function(response){
                console.log("Obtenidos...");
                console.log(response);
                
                var i;
                for(i = 0 ; i < response.length ; i++){
                    var button = document.createElement("button");
                    var node = document.createTextNode(response[i].channel);
                    button.className = "w3-button w3-block w3-border";
                    button.setAttribute('id', response[i].channel);
                    button.setAttribute('onclick', "loadModalFree('"+ response[i].channel +"')");
                    
                    button.appendChild(node);

                    var newBtn = document.getElementById("client_list_free");
                    newBtn.appendChild(button);
                }

                sessionStorage.setItem('frees', JSON.stringify(response));

            },
            error: function(){
                console.log("Error");
                console.log(response);
            }

        }); 

    }

    $(function () {
        
        getClientListFree();
        getClientListAssociated(sessionStorage.frees);
        
    });

</script>