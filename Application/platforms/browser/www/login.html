<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">

		<title>Adaptative</title>

		<!-- W3 CSS CDN-->
		<link rel="stylesheet" href="libs/w3/w3.css">
		
		<style>
            html, body{
                width: 100%;
                height: 100%;
                margin: 0 auto !important;
                padding: 0 auto !important;
            }
			a:link {
				text-decoration:none;
			}
		</style>
    </head>
    <body>
        <div class="w3-main">

            <div class="w3-dark-gray">
                <div class="w3-container">
                    <h2>
                        Adaptative	
                    </h2>
                </div>
            </div>
            
        </div>

        <div class="w3-container w3-padding-24">
            <div class="w3-col" style="width:20%"><p></p></div>

            <div class="w3-col" style="width:60%">
                <div class="w3-card-4">

                    <header class="w3-container w3-black w3-center" id="title">
                        <h1>Authorization</h1>
                    </header>

                    <div class="w3-container w3-dark-grey w3-padding-16" id="form">
                        <label><b>User</b></label>
                        <input class="w3-input w3-border w3-round w3-margin-top w3-margin-bottom" type="text" id="userSend" required autofocus>
                        <label><b>Password</b></label>
                        <input type="password" class="w3-input w3-border w3-round w3-margin-top w3-margin-bottom" type="text" id="passSend" required>
                        <button class="w3-btn w3-round w3-margin-top w3-black" onclick="login()">Login</button>
                        <button class="w3-btn w3-round w3-margin-top w3-black w3-margin-left" onclick="register()">Register</button>
                    </div>
            
                </div>
            </div>

            <div class="w3-col" style="width:20%"><p></p></div>
        </div>

        <div class="w3-container w3-center">
            <div id="warning" class="w3-panel w3-red"></div>
        </div>
        
        <script type="text/javascript" src="libs/jquery/3.4.1/jquery.js"></script>
        <script type="text/javascript">

            function parseJwt (token) {
				var base64Url = token.split('.')[1];
				var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
				var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
					return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
				}).join(''));

				return JSON.parse(jsonPayload);
			};

            function register(){

                location.href = "http://sign.dalher.net/v1/register";

            }

            function login(){

                $( "#warning" ).empty();
                
                var userSend = document.getElementById("userSend").value;

                if(userSend == '' || !userSend){
                    var warning = document.createElement("p");
                    var node = document.createTextNode("You must send a user! Try again, please.");

                    warning.appendChild(node);

                    var element = document.getElementById("warning");
                    element.appendChild(warning);
                }

                var passSend = document.getElementById("passSend").value;

                if(passSend == '' || !passSend){
                    var warning = document.createElement("p");
                    var node = document.createTextNode("You must send a password! Try again, please.");

                    warning.appendChild(node);

                    var element = document.getElementById("warning");
                    element.appendChild(warning);
                }

                if(userSend != '' && passSend !=''){

                    var client_id = '8ea2ad8b-42b0-4551-8d34-2bb9128cbe7d';
                    var client_secret = 'secret';

                    $.ajax({
                        url: 'http://oauth.dalher.net/v2/token',
                        type: 'post',
                        contentType: 'application/x-www-form-urlencoded',
                        headers: {
                            "Authorization": "Basic "+ btoa(client_id + ":" + client_secret),
                        },
                        data: "grant_type=password&username="+ userSend +"&password="+ passSend +"&scope=broker_w broker_r broker_d",
                        beforeSend: function(){
                            console.log("Enviando petición de Autenticación...");
                        },
                        success: function(response){
                            sessionStorage.setItem('refresh_token', response.refresh_token);
                            sessionStorage.setItem('access_token', response.access_token);
                            sessionStorage.setItem('expires_in', response.expires_in);

				            var payload = parseJwt(sessionStorage.access_token);

                            sessionStorage.setItem('sandbox', payload.data.sandbox);
                            sessionStorage.setItem('user_id', payload.data.user_id);
                            sessionStorage.setItem('scope', payload.data.scope);

                            sessionStorage.setItem('user', userSend);
                            sessionStorage.setItem('pass', passSend);

                            location.href = "index.html";
                        },
                        error: function (response){
                            var warning = document.createElement("p");
                            var node = document.createTextNode("You must send a valid user and password! Try again, please.");

                            warning.appendChild(node);

                            var element = document.getElementById("warning");
                            element.appendChild(warning);
                        }

                    });
                    
                }

            }

        </script>
    </body>

</html>