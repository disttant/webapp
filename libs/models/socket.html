<!-- Model Form -->
<div class="d-flex flex-column w-100 border h-100 alert alert-light" role="alert">

    <!-- Header -->
    <div class="d-flex flex-column">
        <div class="p-2">
            <div id="modelType" class="font-weight-bold text-capitalize">{{modelType}}</div>
            <div id="modelName" class="small">{{modelName}}</div>
        </div>
        <div id="modelDescription" class="p-2 text-capitalize">
            {{modelDescription}}
        </div>
    </div>



    <div>
        <hr />
    </div>

    <!-- Power -->
    <div class="d-flex justify-content-between p-2 py-4">
        <div class="my-auto">
            <i class="material-icons md-36">power_settings_new</i>
        </div>
        <div class="my-auto">
            <label class="switch">
                <input type="checkbox" x-command="power">
                <span class="slider round"></span>
            </label>
        </div>
    </div>



    <div>
        <hr />
    </div>

    <!-- Pomodoro -->
    <div class="d-flex justify-content-between p-2 pt-4">
        <div class="my-auto">
            Pomodoro
            <div class="d-block text-muted small">Routine</div>
        </div>

        <div class="my-auto">
            <div class="py-3">
                <div class="d-flex justify-content-center border mb-4 rounded p-2" x-label-for="pomodoro">
                    -
                </div>
                <input type="range" min="0" max="255" step="1" x-command="routine" x-routine="pomodoro">
            </div>
        </div>
    </div>


    

</div>

<script>

    $(function() {

        /*
        *
        * FUTURE MESSAGE DEFINITION
        * 
        */
        var status = {
            power : { 
                state : false,
            },
            routine : {
                pomodoro    : {
                    step : 0,
                },
            }
        }



        /*
        *
        * SETTING FUNCTION DEFINITIONS
        * 
        */

        // Take from server and set starting values for statusCache
        function initStatusCache () {

        }

        // Update statusCache with another status by entering a JSON object
        window.updateState = function ( statusHolder = {}, status = {} ){

            let statusCache = status;

            // Check statusHolder
            if ( typeof statusHolder !== 'object' )
                return;

            if ( statusHolder.hasOwnProperty('command') !== true )
                return;

            if ( statusHolder.hasOwnProperty('routine') !== true )
                return;

            if ( statusHolder.hasOwnProperty('field') !== true )
                return;
            
            if ( statusHolder.hasOwnProperty('value') !== true )
                return;

            // Check status
            if ( typeof status !== 'object' )
                return;

            if ( statusHolder.routine === true ){
                statusCache['routine'][statusHolder.command][statusHolder.field] = statusHolder.value;
            }else{
                statusCache[statusHolder.command][statusHolder.field] = statusHolder.value;
            }

            return statusCache;
        }

        // Move selected switch left or right by code
        window.setSwitch = function ( name, state ){

            if (typeof state !== 'boolean' ){
                state = $('body').find('input[type="checkbox"][x-command="'+name+'"]').prop('checked');
            }

            // Setting the state of power switch
            $('body').find('input[type="checkbox"][x-command="'+name+'"]').attr('checked', state);

        }

        // Move pomodoro slider to a position by code
        window.setPomodoro = function ( step ){

            if (typeof step !== 'number' ){
                step = $('body').find('input[type="range"][x-command="routine"][x-routine="pomodoro"]').val();
            }

            // First part of the slider
            let divider = 3;
            let squareInfo = Math.round( step / divider) + 'm';

            // Second part of the slider
            if ( step > 179 ){
                divider = 15;
                squareInfo = Math.round( (step-180) / divider);

                // Bugfix
                if ( squareInfo == 0 ){ squareInfo = 1 }

                squareInfo += 'h';
            }

            // Setting the brightness square color
            $('body').find('div[x-label-for="pomodoro"]').html(squareInfo).fadeOut( 400 ).fadeIn( 100 );
            

            // Resetting the slider
            $('body').find('input[type="range"][x-command="routine"][x-routine="pomodoro"]').val(step);

        }

        // Set initial GUI conditions
        // taking the status from statusCache
        window.initComponents = function (){

            setSwitch( 'power', status.power.state );
            setPomodoro( status.routine.pomodoro.step );

        }



        /*
        *
        * SETTING INITIAL VALUES
        * 
        */
        initStatusCache ();
        initComponents ();



        /*
        *
        * DETECTING COMPONENTS
        * FOR INTERNAL PURPOSE
        * 
        */

        // Clean some events
        $('body').off();

        $('body').on('input', 'input', function(){

            // Update the GUI
            setSwitch( 'power' ); // <----------------------------------------------
            setPomodoro(  );      // <----------------------------------------------   AUNAR EN UNA FUNCION
    
        });



        /*
        *
        * DETECTING COMPONENTS
        * FOR SENDING COMMANDS
        * 
        */

        // Detecting status change
        $('body').on('change', 'input', function(){

            // Save current state
            let currentStatus = status;

            // Save future status
            let statusHolder   = {
                command : null,
                routine : false,
                field   : null,
                value   : null
            };

            // Save sendable fields
            let device         = $('#modelName').html();
            let command        = $(this).attr('x-command');
            let routine        = $(this).attr('x-routine');

            // Save cache vars for building final string
            let order          = '';
            let data           = '';

            // Build the basic part of the order
            order = 'for|' + device + '|' + command;
            statusHolder['command'] = command;

            // Add the name of routine if present
            if ( typeof routine !== 'undefined' ) {
                data += 'name#' + routine + '|';
                statusHolder['command'] = routine;
                statusHolder['routine'] = true;
            }

            // Add other information fields
            // For switches
            if( $(this).attr('type') === 'checkbox' ){
                data += 'state#' + $(this).prop('checked') + '|';
                statusHolder['field'] = 'state';
                statusHolder['value'] = $(this).prop('checked');
            }

            // For sliders
            if( $(this).attr('type') === 'range' ){
                data += 'step#' + $(this).prop('value') + '|';
                statusHolder['field'] = 'step';
                statusHolder['value'] = $(this).prop('value');
            }

            // Build the entire order
            order += '|' + data;

            // Sending the order to the device
            app.spinnerType = 'bar';
            
            window.device.sendAndGet( device, command, function( result ) {

                if( result !== false ){

                    // Update values
                    window.status = updateState ( statusHolder, status );

                    // Inform the user
                    app.sendToast('Task done');

                }else{

                    // Update values
                    window.status = currentStatus;

                    // Inform the user
                    app.sendToast('Task failed');
                    
                }

                // Update GUI to memory status
                window.initComponents();
                
            }, data);

            

        });






















        /*

        config.models.timers.forEach(function(timer) {

            clearInterval(timer);

        });

        let actualValue; // = VALOR DEL CACHARRO

        $('#powerSwitch').on('change', function() {
            
            clearInterval(config.models.timers[0]);

            config.models.timers[0] = setInterval(function() {

                let newValue = $('#powerSwitch').prop('checked');

                if(newValue !== actualValue){

                    $('#powerSwitch').attr('disabled', true);

                    // ENVIO COMANDO AL CLIENTE
                    app.spinnerType = 'bar';

                    device.sendAndGet( $('#device').text(), 'changepinstate', function( result ) {

                        if(result !== false){

                            actualValue = newValue;
                            app.sendToast('Changed');

                        }else{

                            app.sendToast('Dont found response');

                            if(newValue === true){

                                actualValue = false;
                                $('#powerSwitch').prop('checked', false);

                            }else{

                                actualValue = true;
                                $('#powerSwitch').prop('checked', true);

                            }

                        }

                        $('#powerSwitch').attr('disabled', false);

                    }, 'output#' + newValue);

                }

                clearInterval(config.models.timers[0]);

            }, 1000);

        });
        
        */

    });

</script>